name: Run Both Shell Scripts Sequentially (env: dev|stage|prod)

on:
  workflow_call:
    inputs:
      workspace:
        required: true
        type: string
      group:
        required: true
        type: string
      project:
        required: true
        type: string
      environment:
        required: true
        type: string
      instance:
        required: true
        type: string
      pool:
        required: true
        type: string
    secrets:
      GH_Token:
        required: true

  workflow_dispatch:
    inputs:
      workspace:
        required: true
        type: string
      group:
        required: true
        type: string
      project:
        required: true
        type: string
      environment:
        required: true
        type: string
      instance:
        required: true
        type: string
      pool:
        required: true
        type: string

permissions:
  contents: write

jobs:
  run-scripts:
    runs-on: self-hosted-0009
    steps:
      - name: Checkout application repository
        uses: actions/checkout@v4
        with:
          path: app

      - name: Checkout Kellanova repository (scripts)
        uses: actions/checkout@v4
        with:
          repository: rakesh26955/kellanova-dmit-template-advanced-test
          ref: main
          token: ${{ secrets.GH_Token }}
          path: temp
          persist-credentials: false

      - name: Make deploy script(s) executable
        run: chmod +x temp/.github/scripts/*.sh

      - name: Validate inputs & map environment token
        id: validate
        run: |
          allowed_envs="dev stage prod"
          allowed_instances="author publish both"
          allowed_pools="kstl kfr gen dam kstl65 kfr65 newkstl65 kfr63"

          IN_WORKSPACE="${{ inputs.workspace }}"
          IN_GROUP="${{ inputs.group }}"
          IN_PROJECT="${{ inputs.project }}"
          IN_ENV="${{ inputs.environment }}"
          IN_INSTANCE="${{ inputs.instance }}"
          IN_POOL="${{ inputs.pool }}"

          contains() {
            list="$1"; item="$2"
            for t in $list; do
              if [ "$t" = "$item" ]; then return 0; fi
            done
            return 1
          }

          if ! contains "$allowed_envs" "$IN_ENV"; then
            echo "ERROR: Invalid environment: $IN_ENV"; exit 1
          fi
          if ! contains "$allowed_instances" "$IN_INSTANCE"; then
            echo "ERROR: Invalid instance: $IN_INSTANCE"; exit 1
          fi
          if ! contains "$allowed_pools" "$IN_POOL"; then
            echo "ERROR: Invalid pool: $IN_POOL"; exit 1
          fi

          case "$IN_ENV" in
            dev) MAPPED_ENV="dev" ;;
            stage) MAPPED_ENV="stg" ;;
            prod) MAPPED_ENV="prd" ;;
            *) echo "Unexpected mapping error for $IN_ENV"; exit 1 ;;
          esac

          echo "mapped_environment=${MAPPED_ENV}" >> "$GITHUB_OUTPUT"
          echo "workspace=${IN_WORKSPACE}" >> "$GITHUB_OUTPUT"
          echo "group=${IN_GROUP}" >> "$GITHUB_OUTPUT"
          echo "project=${IN_PROJECT}" >> "$GITHUB_OUTPUT"
          echo "instance=${IN_INSTANCE}" >> "$GITHUB_OUTPUT"
          echo "pool=${IN_POOL}" >> "$GITHUB_OUTPUT"

      - name: Check for .zip files in workspace
        run: |
          WS="app/${{ steps.validate.outputs.workspace }}"
          if compgen -G "${WS}/*.zip" > /dev/null; then
            echo ".zip files found."
          else
            echo "No .zip files found in '${WS}'. Aborting."
            exit 1
          fi

      - name: Run deploy-content-packages wrapper
        run: |
          DEPLOY_WRAPPER="temp/.github/scripts/deploy-content-packages.sh"
          chmod +x "$DEPLOY_WRAPPER" || true
          bash "$DEPLOY_WRAPPER" \
            "app/${{ steps.validate.outputs.workspace }}" \
            "${{ steps.validate.outputs.group }}" \
            "${{ steps.validate.outputs.project }}" \
            "${{ steps.validate.outputs.mapped_environment }}" \
            "${{ steps.validate.outputs.instance }}" \
            "${{ steps.validate.outputs.pool }}"

      - name: Optional brief wait
        if: always()
        run: sleep 15
